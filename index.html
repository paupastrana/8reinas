<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-Reinas: Solucionador Visual de Backtracking</title>
    <link rel="stylesheet" href="principal.css">
</head>
<body>

    <header>
        <h1>üëë Solucionador Visual de N-Reinas üëë</h1>
        <p>Algoritmo de Backtracking paso a paso.</p>
    </header>

    <div class="controls-panel">
        <label for="boardSize">Tama√±o del Tablero (N):</label>
        <input type="number" id="boardSize" value="8" min="4" max="12" onchange="resetBoard()">
        <button id="solveButton" onclick="handleSolve()">Resolver</button>
        <button id="nextStepButton" onclick="nextStep()" disabled>Siguiente Paso</button>
    </div>

    <div class="status-panel">
        <p>Estado: <span id="statusMessage">Esperando...</span></p>
        <p>Acci√≥n Actual: <span id="currentAction">N/A</span></p>
    </div>

    <div id="boardContainer" class="board-container">
        </div>

    <footer>
        <p>Nota: N restringido entre 4 y 12 para una buena visualizaci√≥n.</p>
    </footer>

    <script>
        const API_URL = "http://127.0.0.1:8000/api/solve"; 
        let animationSteps = [];
        let currentStepIndex = 0;
        let animationInterval;
        let N = 8; // Tama√±o inicial
        
 
        // Genera el tablero
        function createBoard(size) {
            const container = document.getElementById('boardContainer');
            container.innerHTML = ''; // Limpiar
            container.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            N = size; // Actualizar el tama√±o global
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell ' + ((i + j) % 2 === 0 ? 'white' : 'black');
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    container.appendChild(cell);
                }
            }
        }
        
        //dibuja el estado de un paso espec√≠fico en el tablero
        function drawBoard(board) {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                cell.innerHTML = '';
                cell.classList.remove('action-place', 'action-remove');

                if (board[row][col] === 1) {
                    //si hay una reina 
                    cell.innerHTML = '‚ôï';
                }
            });
        }
        
   

        async function handleSolve() {
            N = parseInt(document.getElementById('boardSize').value);
            
            if (N < 4 || N > 12) {
                alert("Por favor, ingresa un tama√±o N entre 4 y 12.");
                return;
            }
            
            clearInterval(animationInterval);
            document.getElementById('solveButton').disabled = true;
            document.getElementById('statusMessage').textContent = 'Calculando...';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ N: N })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error en la API: ' + data.error);
                } else if (data.message) {
                    document.getElementById('statusMessage').textContent = data.message;
                    drawBoard(data.steps[data.steps.length - 1]?.board || []);
                } else {
                    animationSteps = data.steps;
                    currentStepIndex = 0;
                    document.getElementById('statusMessage').textContent = 'Animando soluci√≥n...';
                    
                    //inicializar el tablero
                    createBoard(N); 
                    
                    //inicar la animacion
                    startAutomaticAnimation(animationSteps); 
                }
            } catch (error) {
                console.error("Error al conectar con el backend:", error);
                document.getElementById('statusMessage').textContent = 'Error de conexi√≥n con la API.';
            } finally {
                document.getElementById('solveButton').disabled = false;
            }
        }
        
        function startAutomaticAnimation(steps) {
            clearInterval(animationInterval); //no hat animacion previa
            
            //control manual
            document.getElementById('nextStepButton').disabled = false;
            
            executeStep(steps[currentStepIndex]);
            document.getElementById('statusMessage').textContent = `Paso ${currentStepIndex + 1} de ${steps.length}`;
            
        }
        
        function nextStep() {
            if (currentStepIndex < animationSteps.length) {
                executeStep(animationSteps[currentStepIndex]);
                currentStepIndex++;
                document.getElementById('statusMessage').textContent = `Paso ${currentStepIndex} de ${animationSteps.length}`;
                
                if (currentStepIndex === animationSteps.length) {
                    document.getElementById('statusMessage').textContent = '¬°Soluci√≥n Finalizada!';
                    document.getElementById('nextStepButton').disabled = true;
                }
            }
        }

        // Ejecuta un paso espec√≠fico, actualizando el tablero y los mensajes
        function executeStep(step) {
            const { board, row, col, action } = step;
            
            drawBoard(board);
            document.getElementById('currentAction').textContent = `${action} en (${row}, ${col})`;
            
            // Resaltar la celda donde ocurri√≥ la acci√≥n
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            if (cell) {
                cell.classList.add(`action-${action.toLowerCase()}`);
            }
        }
        
        // Reiniciar la interfaz
        function resetBoard() {
            const newN = parseInt(document.getElementById('boardSize').value);
            createBoard(newN);
            clearInterval(animationInterval);
            animationSteps = [];
            currentStepIndex = 0;
            document.getElementById('statusMessage').textContent = 'Esperando...';
            document.getElementById('currentAction').textContent = 'N/A';
            document.getElementById('nextStepButton').disabled = true;
        }

        // Inicializar el tablero al cargar la p√°gina
        window.onload = () => createBoard(N);
    </script>

</body>
</html>